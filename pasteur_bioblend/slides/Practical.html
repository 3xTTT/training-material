<!DOCTYPE html>
<html>
  <head>
    <title>BioBlend_API</title>
    <meta charset="utf-8">
    <style>
      @import url("../shared/css/fonts.css");

      body { font-family: 'Droid Serif'; }
      h1, h2, h3 {
        font-family: 'Yanone Kaffeesatz';
        font-weight: normal;
      }
      .remark-code, .remark-inline-code { font-family: 'Ubuntu Mono'; }
    </style>
  </head>
  <body>
    <textarea id="source">

name: start

###Preparation du TP
Il vous faut tout d'abord recuperer votre cle d'authentification api, sur l'interface galaxy, onglet user, menu Api Keys vous pourrez generer puis sauver votre cle

Pour avoir une base commune installez les outils bam_to_sam et samtools_sort (owner iuc) depuis l'interface admin et le toolsheds "main" (onglet admin, Search Tool Shed, Galaxy Main Tool Shed)

Recuperez le workflow (.ga) depuis https://github.com/fmareuil/formationbioblend (git clone https://github.com/fmareuil/formationbioblend.git)

Installez le workflow depuis l'interface workflow / Upload or import workflow

###But

1. Se familiariser avec la librairie bioblend
2. Executer un outil grace a bioblend sur son galaxy
3. Executer un workflow grace a bioblend sur son galaxy

---
Pour commencer, demarrez ipython et connectez vous a votre galaxy avec bioblend
Recuperez votre api key et l'url de galaxy

* Chargez le module bioblend :

```python
from bioblend.galaxy import GalaxyInstance
```

* Creez un objet GalaxyInstance avec votre url et votre key

```python
gi = GalaxyInstance(url="http://127.0.0.1:8080", key="votre key")
```

* ipython: la completion automatique
Tapez `gi.` puis appuyez sur la touche tab
Utilisez `help(command)`, `object??`, `object?`... pour comprendre les methodes/classes


---

* Qu'est ce qu'il faut pour ex√©cuter un outil?:

```python
help(gi.tools.run_tool)
```


```asciidoc
run_tool(self, history_id, tool_id, tool_inputs) method of bioblend.galaxy.tools.ToolClient instance
    Runs tool specified by ``tool_id`` in history indicated
    by ``history_id`` with inputs from ``dict`` ``tool_inputs``.
    
    :type tool_inputs: dict
    :param tool_inputs: dictionary of input datasets and parameters
      for the tool (see below)
    
    The ``tool_inputs`` dict should contain input datasets and parameters
    in the (largely undocumented) format used by the Galaxy API.
```

---
* Les historiques : 
    * Essayer de recuperer la liste entiere des donnees d'un historique
    * Creez un nouvel historique, ce sera, notre historique de travail

```python
liste_histories = gi.histories.get_histories()
new_history = gi.histories.create_history(name='my_history')
```

    * Il n'y a pas de methode pour uploader une donnee depuis le "file system", par contre il y a une methode pour le faire depuis une "library"

```python
help(gi.histories.upload_dataset_from_library)
```

.bold[Il faut maintenant creer une library et uploader une donnee dedans]

---
* Les librairies :
    * Verifier s'il y a une methode pour uploader une donnee depuis le systeme de fichiers
    help(gi.libraries.upload_file_from_local_path)
    * Creez une library, positionnez correctement les droits galaxy sur la "library" (il vous faudra l'id' de votre role, regardez `gi.roles`) puis importez un fichier bam dedans


```python
new_lib = gi.libraries.create_library('ma_librairie')
gi.libraries.set_library_permissions(new_lib['id'],access_in=['role_id'], modify_in=['role_id'], add_in=['role_id'], manage_in=['role_id'])
list_data = gi.libraries.upload_file_from_local_path(new_lib['id'], local_path)
```

    * Copiez le fichier bam de votre library dans un nouveau history

```python
data_history = gi.histories.upload_dataset_from_library(new_history['id'], list_data[0]['id'])
```

---
* Les outils :
    * Pour executer un outil il me faut aussi son 'id', help(gi.tools.run_tool)
    * Recuperer l'id de l'outil samtools sort, son nom dans le xml est sort
    
```python
list_tool = gi.tools.get_tools(name='sort')
```

    * tool_inputs, qu'est ce que c'est? (pas beaucoup de doc, c'est un dict python)
    * Construction d'un objet tool_inputs a l'aide de methodes specifiques :
    
```python
from bioblend.galaxy.tools.inputs import inputs
```

    * la methode inputs est en fait une classe InputsBuilder help(inputs)
    * Pour chaque input defini dans le xml d'un outil on peut lui attribuer une valeur avec les methodes set_param ou set_dataset_param de la classe InputsBuilder
    * En cas d'input de type data il faut utiliser la methode set_dataset_param
    
```python
myinputs = inputs().set_param("param1",'value').set_dataset_param("data1",'dataset_id',src="hda")
```

.bold[Il nous faut plus d'information sur l'outil]

---
* Les outils :
    * Recuperez des details sur l'outil `samtool sort`
```python     
detail_tool = gi.tools.show_tool(list_tool[0]['id'],io_details=True)
```
    * Avec les infos de detail_tool['inputs'], on peut instancier notre objet InputBuilder.
```python    
myinputs = inputs().set_dataset_param("input1", data_history['id'], src='hda').set_param("sort_mode","")
```
    * Executez l'outil `samtool sort`
```python
gi.tools.run_tool(new_history['id'], detail_tool['id'], myinputs)
```

---
* Les workflows :
    * Qu'est ce qu'il faut pour executer un workflow
```python
help(gi.workflows.run_workflow)
```

```asciidoc
run_workflow(self, workflow_id, dataset_map=None, params=None, history_id=None, history_name=None, import_inputs_to_history=False, replacement_params=None) method of bioblend.galaxy.workflows.WorkflowClient instance
    Run the workflow identified by ``workflow_id``
    
    :type workflow_id: string
    :param workflow_id: Encoded workflow ID
    
    :type dataset_map: string or dict
    :param dataset_map: A mapping of workflow inputs to datasets. The datasets...
```
*    * Recuperez le detail du workflow avec l'api
```python
mon_workflow = gi.workflows.get_workflows(name="wf_formation (imported from uploaded file)")
detailworkflow = gi.workflows.show_workflow(mon_workflow[0]['id'])
```

---
* Les workflows :
    * Construisez le dataset_map (`cle = "cle de l'input du workflow" valeur = {id : 'id d'une data', src : 'localisation de la data'}`) 
```python
dataset_map = {}
dataset_map[detailworkflow['inputs'].keys()[0]] = {'id' : data_history['id'], 'src' : 'hda'}
```
    * Executez le workflow
```python
gi.workflows.run_workflow(detailworkflow['id'],dataset_map=dataset_map, history_id=new_history['id'])
```

.bold[Maintenant essayez avec un autre outil ou un autre workflow.]


[return](index#plan)
    </textarea>
    <script src="../shared/js/remark-latest.min.js">
    </script>
    <script>
      var slideshow = remark.create();
    </script>
  </body>
</html>
