<!DOCTYPE html>
<html>
  <head>
    <title>BioBlend_API</title>
    <meta charset="utf-8">
    <style>
      .left-column5 {
      width: 5%;
      float: left;
      }

     .right-column95 {
      width: 93%;
      float: right;
      }


      .left-column95 {
      width: 93%;
      float: left;
      }

     .right-column5 {
      width: 5%;
      float: right;
      }
      
      .reduce70 {
      font-size: 70%
      }
      
      .reduce90 {
      font-size: 90%
      }
      
      @import url("../shared/css/fonts.css");

      body { font-family: 'Droid Serif'; }
      h1, h2, h3, h4, h5, h6 {
        font-family: 'Yanone Kaffeesatz';
        font-weight: normal;
      }
      .remark-code, .remark-inline-code { font-family: 'Ubuntu Mono'; }
    </style>
  </head>
  <body>
  <textarea id="source">


name: start

### Before we start
1. Authentication for Bioblend - Get your API key:
	* On your Galaxy, click on the User tab and ont the "API Keys" line
	* Click on "Generate a new key now"

2. Install the tools and workflow on your Galaxy:
	1. The tools:  
	Admin tab
		* In the Tools and Tool Shed category, click on the line "Search Tool Shed"
		* Select the "Galaxy Main Tool Shed", and the "Browse valid repositories" line
		* Search and install "bam_to_sam" and "samtools_sort" from IUC owner using the
	2. The workflow:
		* Get the workflow file (.ga) from https://github.com/fmareuil/formationbioblend
		* Import the workflow in galaxy:  
		Click on Workflow tab and "Upload or import workflow" button
	3. Launch ipython on a terminal

---

### Goal
1. Get familiar with BioBlend with ipython
2. Launch a Galaxy job / Visualize your actions with Galaxy
3. Launch a Galaxy workflow / Visualize your actions with Galaxy


---
### Connect with Galaxy using ipython:

* Get your API key and your Galaxy URL
* Import the GalaxyInstance object from BioBlend module:

```python
from bioblend.galaxy import GalaxyInstance
```
* Create your GalaxyInstance instance object using your url and your key

```python
gi = GalaxyInstance(url="http://127.0.0.1:8080", key="your key")
```
### Why ipython:
* Automatic completion  
==> type **gi.** and the tab puis appuyez sur la touche tab key

* To better understand BioBlend methods and classes, you can use
*help(command), object??, object?...*


---

### To launch a Galaxy job

* Understanding the run_tool method; **run_tool** method:
	* The help command lets the user know what are the arguments
        ```python
        help(gi.tools.run_tool)
        ```
        ```asciicode
        run_tool(self, history_id, tool_id, tool_inputs) method of bioblend.galaxy.tools.ToolClient instance
            Runs tool specified by **tool_id** in history indicated by *history_id* with inputs from *dict* *tool_inputs*.

            :type tool_inputs: dict
            :param tool_inputs: dictionary of input datasets and parameters for the tool (see below)

            The tool_inputs dict should contain input datasets and parameters in the (largely undocumented) format used by the Galaxy API.
        ```
    * To resume, in this first part, we need to retrieve:
        1. A *history_id*, where the input data is and where the output data will be
        2. A *tool_id*, which will tell Galaxy which tool to execute
        3. *tool_inputs*, dictionary storing the data used to run the tool


---
.right-column5[.reduce70[*history_id*]]
.left-column95[### Histories Object]

* Try to get your histories list with BioBlend 
* Create a new history (*It will be our work history for this tutorial*)
      
.left-column5[<img src="../images/clue.png" width="30"/>] [http://bioblend.readthedocs.org](http://bioblend.readthedocs.org)
.right-column5[<img src="../images/yourturn.jpg" width="100"/>] 

---
.right-column5[.reduce70[*history_id*]]
.left-column95[### Histories Object]

* Try to get your histories list with BioBlend 
* Create a new history (*It will be our work history for this tutorial*)
      
.left-column5[<img src="../images/clue.png" width="30"/>] [http://bioblend.readthedocs.org](http://bioblend.readthedocs.org)
.right-column5[<img src="../images/yourturn.jpg" width="100"/>] 


```python
list_histories = gi.histories.get_histories()

new_history = gi.histories.create_history(name='my_history')
```
---
### Histories Object

* Try to get your histories list with BioBlend 
* Create a new history (*It will be our work history for this tutorial*)
      
.left-column5[<img src="../images/clue.png" width="30"/>] [http://bioblend.readthedocs.org](http://bioblend.readthedocs.org)
.right-column5[<img src="../images/yourturn.jpg" width="100"/>] 


```python
list_histories = gi.histories.get_histories()

new_history = gi.histories.create_history(name='my_history')
```      
      
* Now that your history is created, you will need to upload some data in it.

---
.right-column5[.reduce70[*history_id*]]
.left-column95[### Histories Object]

* Try to get your histories list with BioBlend 
* Create a new history (*It will be our work history for this tutorial*)
      
.left-column5[<img src="../images/clue.png" width="30"/>] [http://bioblend.readthedocs.org](http://bioblend.readthedocs.org)
.right-column5[<img src="../images/yourturn.jpg" width="100"/>] 


```python
list_histories = gi.histories.get_histories()

new_history = gi.histories.create_history(name='my_history')
```      

* Now that your history is created, you will need to upload some data in it.

      
* No BioBlend method to directly upload data from your file system to a history exists, a data can be uploaded in a history from a Galaxy library


```python
help(gi.histories.upload_dataset_from_library)
```

---
.right-column5[.reduce70[*history_id*]]
.left-column95[### Librairies Object]

* Check if there is a method to upload a data from your filesystem

.left-column5[
<img src="../images/clue.png" width="30"/>
]
.right-column95[
```python
help(gi.libraries.upload_file_from_local_path)
```
]
---
### Librairies Object

* Check if there is a method to upload a data from your filesystem

.left-column5[
<img src="../images/clue.png" width="30"/>
]
.right-column95[
```python
help(gi.libraries.upload_file_from_local_path)
```
]
      
* Create a library and set the rights to this library

.left-column5[
<img src="../images/clue.png" width="30"/>
]
.right-column95[
you will need your role *id*, look for the methods of the Class *gi.roles*
]
.right-column95[<img src="../images/yourturn.jpg" width="100"/>] 
      
---
.right-column5[.reduce70[*history_id*]]
.left-column95[### Librairies Object]

* Check if there is a method to upload a data from your filesystem
      
.left-column5[
<img src="../images/clue.png" width="30"/>
]
.right-column95[
```python 
help(gi.libraries.upload_file_from_local_path)
```
]

* Create a library and set the rights to this library

.left-column5[
<img src="../images/clue.png" width="30"/>
]
.right-column95[
you will need your role *id*, look for the methods of the Class *gi.roles*
]
          
```python
new_lib = gi.libraries.create_library('my_library')
gi.libraries.set_library_permissions(new_lib['id'], access_in=['role_id'],
      modify_in=['role_id'], add_in=['role_id'], manage_in=['role_id'])
```
      
* import a BAM file in your library      
      
---
### Librairies Object

* Check if there is a method to upload a data from your filesystem
      
.left-column5[
<img src="../images/clue.png" width="30"/>
]
.right-column95[
```python 
help(gi.libraries.upload_file_from_local_path)
```
]

* Create a library and set the rights to this library

.left-column5[
<img src="../images/clue.png" width="30"/>
]
.right-column95[
you will need your role *id*, look for the methods of the Class *gi.roles*
]
          
```python
new_lib = gi.libraries.create_library('my_library')
gi.libraries.set_library_permissions(new_lib['id'], access_in=['role_id'],
      modify_in=['role_id'], add_in=['role_id'], manage_in=['role_id'])
```
      
* import a BAM file in your library
```python
      list_data = gi.libraries.upload_file_from_local_path(new_lib['id'], local_path)
```

* Transfer the BAM file from your library in your new history
.right-column5[
<img src="../images/yourturn.jpg" width="50"/>
]

      
---
.right-column5[.reduce70[*history_id*]]
.left-column95[### Librairies Object]

* Check if there is a method to upload a data from your filesystem
      
.left-column5[
<img src="../images/clue.png" width="30"/>
]
.right-column95[
```python 
help(gi.libraries.upload_file_from_local_path)
```
]

* Create a library and set the rights to this library

.left-column5[
<img src="../images/clue.png" width="30"/>
]
.right-column95[
you will need your role *id*, look for the methods of the Class *gi.roles*
]
          
```python
new_lib = gi.libraries.create_library('my_library')
gi.libraries.set_library_permissions(new_lib['id'], access_in=['role_id'],
      modify_in=['role_id'], add_in=['role_id'], manage_in=['role_id'])
```
      
* import a BAM file in your library
```python
      list_data = gi.libraries.upload_file_from_local_path(new_lib['id'], local_path)
```
* Transfer the BAM file from your library in your new history
.right-column5[
<img src="../images/yourturn.jpg" width="50"/>
]
      

```python
data_history = gi.histories.upload_dataset_from_library(new_history['id'],
      list_data[0]['id'])
```

---
### Tools Object (1/3)

* To run a tool, its 'id' is needed:
      <img src="../images/clue.png" width="30"/>  help(gi.tools.run_tool)

* Get the samtools sort tool id
      <img src="../images/clue.png" width="30"/>  its name in "sort"

---
### Tools Object (1/3)
* To run a tool, its 'id' is needed:
      <img src="../images/clue.png" width="30"/>  help(gi.tools.run_tool)

* Get the samtools sort tool id
      <img src="../images/clue.png" width="30"/>  its name in "sort"

```python
list_tool = gi.tools.get_tools(name='sort')
```

---
### Tools Object (2/3)
* To run a tool, the dictionary *tool_inputs* is needed

* It is a python dictionary defined by specific methods from the bioblend.galaxy.tools.inputs Class


```python
from bioblend.galaxy.tools.inputs import inputs
```

* The *inputs* method is a Class called InputsBuilder:<img src="../images/clue.png" width="30"/>  help(inputs)
* Each input defined in the tool XML needs to be defined using the methods *set_param* or *set_dataset_param* from InputsBuilder Class
 ==> If the input format is "data", the method to use is *set_dataset_param*

* Here is an example:       
```python
myinputs = inputs().set_param("param1",'value').set_dataset_param("data1",'dataset_id',src="hda")
```
      
.center[**To run the tool samtools sort, we need more information on the tool itself**]       
      

---
### Tools Object (3/3)
* Recuperez des details sur l'outil `samtool sort`

```python
detail_tool = gi.tools.show_tool(list_tool[0]['id'],io_details=True)
```

* Avec les infos de detail_tool['inputs'], on peut instancier notre objet InputBuilder.

```python
myinputs = inputs().set_dataset_param("input1", data_history['id'], src='hda').set_param("sort_mode","")
```

* Executez l'outil `samtool sort`

```python
gi.tools.run_tool(new_history['id'], detail_tool['id'], myinputs)
```

---
### Workflows Object
* Qu'est ce qu'il faut pour executer un workflow

```python
help(gi.workflows.run_workflow)
```

```asciidoc
run_workflow(self, workflow_id, dataset_map=None, params=None, history_id=None, history_name=None, import_inputs_to_history=False, replacement_params=None) method of bioblend.galaxy.workflows.WorkflowClient instance
    Run the workflow identified by ``workflow_id``

    :type workflow_id: string
    :param workflow_id: Encoded workflow ID

    :type dataset_map: string or dict
    :param dataset_map: A mapping of workflow inputs to datasets. The datasets...
```

* Recuperez le detail du workflow avec l'api

```python
mon_workflow = gi.workflows.get_workflows(name="wf_formation (imported from uploaded file)")
detailworkflow = gi.workflows.show_workflow(mon_workflow[0]['id'])
```

---
### Workflows Object

* Les workflows :
    * Construisez le dataset_map (*cle = "cle de l'input du workflow" valeur = {id : 'id d'une data', src : 'localisation de la data'}*)
```python
dataset_map = {}
dataset_map[detailworkflow['inputs'].keys()[0]] = {'id' : data_history['id'], 'src' : 'hda'}
```
    * Executez le workflow
```python
gi.workflows.run_workflow(detailworkflow['id'], dataset_map=dataset_map, history_id=new_history['id'])
```

.center[**Maintenant essayez avec un autre outil ou un autre workflow.**]


[return](index#plan)
    </textarea>
  <script src="../shared/js/remark-latest.min.js">
    </script>
    <script>
      var slideshow = remark.create();
    </script>
  </body>
</html>


